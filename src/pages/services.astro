---
import BaseLayout from '@layouts/BaseLayout.astro';
import ContactCTA from '@components/ContactCTA.astro';
import { getCollection } from 'astro:content';

const services = await getCollection('services');
const sortedServices = services.sort((a, b) => a.data.order - b.data.order);
---

<BaseLayout
  title="Services"
  description="System integration, custom development, and data analytics solutions for small to mid-size businesses."
>
  <!-- Hero Section with Gradient -->
  <section class="bg-gradient-to-br from-charcoal to-charcoal/90 text-white py-20">
    <div class="container mx-auto px-6">
      <div class="max-w-3xl">
        <h1 class="font-heading text-5xl font-bold mb-6">
          Services Built for Real-World Complexity
        </h1>
        <p class="text-xl text-white/90">
          We solve the technical challenges that prevent businesses from scaling: disconnected systems, manual workflows, and data trapped in silos.
        </p>
      </div>
    </div>
  </section>

  <!-- Services Catalog with Sidebar Navigation -->
  <section class="py-16 bg-slate-50">
    <div class="container mx-auto px-6">
      <div class="flex flex-col lg:flex-row gap-12 max-w-7xl mx-auto">
        <!-- Sticky Sidebar Navigation -->
        <aside class="lg:w-72 flex-shrink-0">
          <div class="lg:sticky bg-white rounded-lg shadow-sm border border-charcoal/10 p-6" 
               style="top: calc(var(--header-height, 180px) + 1rem);">
            <h2 class="font-heading text-lg font-bold text-charcoal mb-4">Our Services</h2>
            <nav class="space-y-2">
              {sortedServices.map((service) => (
                <a
                  href={`#${service.data.slug}`}
                  class="service-nav-link block px-4 py-2 rounded-md text-charcoal-light hover:bg-copper/10 hover:text-copper transition-colors duration-200"
                >
                  {service.data.title}
                </a>
              ))}
            </nav>
            
            <div class="mt-8 pt-8 border-t border-charcoal/10">
              <p class="text-sm text-charcoal-light mb-4">
                Not sure which service fits your needs?
              </p>
              <a
                href="/contact"
                class="block text-center px-4 py-2 bg-copper text-white rounded-md hover:bg-copper-dark transition-colors duration-200 text-sm font-semibold"
              >
                Schedule a Consultation
              </a>
            </div>
          </div>
        </aside>

        <!-- Services Content -->
        <div class="flex-1 space-y-12">
          {sortedServices.map(async (service) => {
            const { Content } = await service.render();
            return (
              <div id={service.data.slug} class="scroll-mt-24">
                <article class="bg-white rounded-lg shadow-sm border border-charcoal/10 p-8 lg:p-10">
                  <div class="flex items-start gap-4 mb-6">
                    {service.data.icon ? (
                      <div class="service-icon-wrapper flex-shrink-0 w-12 h-12 flex items-center justify-center">
                        <img
                          src={service.data.icon}
                          alt={`${service.data.title} icon`}
                          class="w-12 h-12"
                          onerror="this.parentElement.style.display='none'"
                        />
                      </div>
                    ) : (
                      <div class="service-icon flex-shrink-0 w-12 h-12 bg-copper/10 rounded-lg flex items-center justify-center">
                        <span class="text-2xl text-copper">‚óè</span>
                      </div>
                    )}
                    <div>
                      <h2 class="font-heading text-3xl font-bold text-charcoal">
                        {service.data.title}
                      </h2>
                    </div>
                  </div>
                  {service.data.thumbnail && (
                    <div class="mb-6 rounded-lg overflow-hidden service-thumbnail-wrapper">
                      <img
                        src={service.data.thumbnail}
                        alt={service.data.title}
                        class="w-full h-64 object-cover"
                        onerror="this.parentElement.style.display='none'"
                      />
                    </div>
                  )}
                  <div class="prose prose-lg max-w-none">
                    <Content />
                  </div>
                </article>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-6">
      <ContactCTA
        title="Let's Discuss Your Integration Needs"
        description="Schedule a technical consultation to explore how we can solve your specific challenges."
      />
    </div>
  </section>
</BaseLayout>

<style>
  .service-nav-link.active {
    @apply bg-copper/10 text-copper font-semibold;
  }

  .prose :global(h2) {
    @apply font-heading text-2xl font-bold text-charcoal mt-8 mb-4;
  }

  .prose :global(h3) {
    @apply font-heading text-xl font-semibold text-charcoal mt-6 mb-3;
  }

  .prose :global(p) {
    @apply text-charcoal-light mb-4 leading-relaxed;
  }

  .prose :global(ul) {
    @apply list-disc list-inside space-y-2 text-charcoal-light ml-4;
  }

  .prose :global(strong) {
    @apply text-charcoal font-semibold;
  }

  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }

  /* Active section highlighting */
  @media (min-width: 1024px) {
    .service-nav-link {
      position: relative;
    }
    
    .service-nav-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background-color: currentColor;
      transition: height 0.2s ease;
    }
    
    .service-nav-link:hover::before,
    .service-nav-link.active::before {
      height: 70%;
    }
  }
</style>

<script>
  // Highlight active section in navigation
  function updateActiveSection() {
    const sections = document.querySelectorAll('[id]');
    const navLinks = document.querySelectorAll('.service-nav-link');
    
    let currentSection = '';
    
    sections.forEach((section) => {
      const sectionTop = section.getBoundingClientRect().top;
      if (sectionTop <= 150) {
        currentSection = section.getAttribute('id') || '';
      }
    });
    
    navLinks.forEach((link) => {
      link.classList.remove('active');
      if (link.getAttribute('href') === `#${currentSection}`) {
        link.classList.add('active');
      }
    });
  }
  
  window.addEventListener('scroll', updateActiveSection);
  window.addEventListener('load', updateActiveSection);
</script>
